<script>
    const parent = window.parent;
    let isGettingElement = false;

    function getIndex(child) {
        const parentElementWhichSameTypes = Array.from(child.parentElement.children).filter((el) => el.tagName === child.tagName);
        if (parentElementWhichSameTypes.length === 1) return -1;
        return [].indexOf.call(parentElementWhichSameTypes, child) + 1;
    }

    function getDomHierarchy(e) {
        const result = [];
        const indexOfElement = getIndex(e);
        result.push(e.tagName + (indexOfElement === -1 ? '' : `:nth-child(${indexOfElement})`));
        while (e?.parentNode.tagName !== 'HTML') {
            const nthChild = getIndex(e?.parentNode);
            if (nthChild === -1) {
                result.push(e?.parentNode.tagName);
            }
            else {
                result.push(e?.parentNode.tagName + `:nth-child(${nthChild})`);
            }
            e = e?.parentNode;
        }
        return result.map(e => e.toLowerCase()).reverse();
    }

    const disableClickEvent = (event) => {
        event.target.pointerEvents = "none";

        try {
            parent.postMessage({
                type: 'selected element',
                domHierarchy: getDomHierarchy(event.target),
                props: {
                    class: event.target.className,
                    id: event.target.id,
                }
            }, '*')
        }
        catch (error) {
            console.log("parent.postMessage error", error)
        }

        setTimeout(() => {
            window.dispatchEvent(new Event('release-pointer-events'));
        }, 500);
    }

    function preventClickEvent() {
        const scrollable = document.body;
        scrollable.addEventListener('mousedown', disableClickEvent, false);

        window.addEventListener('release-pointer-events', function () {
            scrollable.style.pointerEvents = "all";
        })
    }

    function releaseClickEvent() {
        const scrollable = document.body;
        scrollable.removeEventListener('mousedown', disableClickEvent, false);
        window.removeEventListener('release-pointer-events', function () {
            scrollable.style.pointerEvents = "all";
        })
    }

    function hightlightELement(el) {
        const existedElement = document.getElementById('highlighted-element');
        if (existedElement) {
            existedElement.remove();
        }

        if (isGettingElement && el) {
            el.style.position = 'relative';
            const newEl = document.createElement('div');
            newEl.id = 'highlighted-element';
            newEl.style.position = 'absolute';
            newEl.style.top = `0`;
            newEl.style.left = `0`;
            newEl.style.width = `100%`;
            newEl.style.height = `100%`;
            newEl.style.border = '2px solid red';
            newEl.style.zIndex = '999999';
            newEl.style.transform = 'scale(1.05)';
            el.appendChild(newEl);

            el.scrollIntoView({
                behavior: 'smooth',
                block: 'center',
                inline: 'center'
            });
        }
    }

    window.addEventListener('message', function (e) {
        if (event.data === "start getting element") {
            isGettingElement = true;
            preventClickEvent()
        }

        if (event.data === "end getting element") {
            isGettingElement = false;
            releaseClickEvent()
        }

        if (event.data === 'clean up') {
            console.log('clean up')
            isGettingElement = false;
            hightlightELement(null);
        }

        if (event.data.type === 'highlight element') {
            isGettingElement = true;
            const selectedElement = event.data.element;
            const { domHierarchy } = selectedElement;
            const element = document.querySelector(domHierarchy.join(' > '));
            hightlightELement(element);
        }
    })
</script>