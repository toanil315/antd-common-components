<script>
    const parent = window.parent;
    const driver = window.driver.js.driver;
    const driverInstance = driver();


    function getIndex(child) {
        const parentElementWhichSameTypes = Array.from(child.parentElement.children).filter((el) => el.tagName === child.tagName);
        if (parentElementWhichSameTypes.length === 1) return -1;
        return [].indexOf.call(parentElementWhichSameTypes, child) + 1;
    }

    function getDomHierarchy(e) {
        const result = [];
        const indexOfElement = getIndex(e);
        result.push(e.tagName + (indexOfElement === -1 ? '' : `:nth-child(${indexOfElement})`));
        while (e?.parentNode.tagName !== 'HTML') {
            const nthChild = getIndex(e?.parentNode);
            if (nthChild === -1) {
                result.push(e?.parentNode.tagName);
            }
            else {
                result.push(e?.parentNode.tagName + `:nth-child(${nthChild})`);
            }
            e = e?.parentNode;
        }
        return result.map(e => e.toLowerCase()).reverse();
    }

    const selectElementToHighlight = (event) => {
        if (event.button === 2) {
            try {
                parent.postMessage({
                    type: 'selected element',
                    element: getDomHierarchy(event.target).join(" > "),
                    url: window.location.href,
                    props: {
                        class: event.target.className,
                        id: event.target.id,
                    }
                }, '*')
            }
            catch (error) {
                console.log("parent.postMessage error", error)
            }
        }
    }

    function preventClickEvent() {
        const scrollable = document.body;
        scrollable.style.cursor = 'grab';
        scrollable.addEventListener('mousedown', selectElementToHighlight, false);
        window.addEventListener("contextmenu", e => e.preventDefault());
    }

    function releaseClickEvent() {
        const scrollable = document.body;
        scrollable.style.cursor = 'default';
        scrollable.removeEventListener('mousedown', selectElementToHighlight, false);
        window.removeEventListener("contextmenu", e => e.preventDefault());
    }

    function highlightELement(step) {
        const { element, popover } = step;
        const elementInstance = document.querySelector(element);

        if (elementInstance) {
            driverInstance.highlight({
                element,
                popover
            })
        }
    }

    window.addEventListener('message', function (e) {
        if (event.data === "start getting element") {
            preventClickEvent();
            driverInstance.destroy();
        }

        if (event.data === "end getting element") {
            releaseClickEvent()
        }

        if (event.data === 'clean up') {
            driverInstance.destroy();
        }

        if (event.data.type === 'highlight element') {
            const { step } = event.data;
            const { url, ...restStep } = step;
            if (window.location.href !== url) {
                return;
            }
            highlightELement(restStep);
        }

        if (event.data.type === 'preview tour') {
            const { steps } = event.data;
            driverInstance.destroy();
            console.log(driverInstance)
            driverInstance.setConfig({ steps });
            driverInstance.drive();
        }
    })
</script>